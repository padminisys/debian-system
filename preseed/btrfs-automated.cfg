#### Debian 12.12 Preseed - Automated Btrfs + Snapper Installation ####
#### Optimized for Indian locale, secure deployment, PXE-ready ####

### Localization - India/English
d-i debian-installer/locale string en_IN.UTF-8
d-i debian-installer/language string en
d-i debian-installer/country string IN
d-i debian-installer/locale string en_IN.UTF-8
d-i keyboard-configuration/xkb-keymap select us
d-i keyboard-configuration/layoutcode string us

### Network Configuration - Prefer Ethernet over WiFi
d-i netcfg/choose_interface select auto
d-i netcfg/get_hostname string debian-btrfs
d-i netcfg/get_domain string localdomain
d-i netcfg/wireless_wep string

### Mirror Configuration - India
d-i mirror/country string manual
d-i mirror/http/hostname string deb.debian.org
d-i mirror/http/directory string /debian
d-i mirror/http/proxy string
d-i mirror/suite string bookworm

### Account Setup - Secure defaults
d-i passwd/root-login boolean true
d-i passwd/root-password password SecureRoot2024!
d-i passwd/root-password-again password SecureRoot2024!
d-i passwd/user-fullname string System Administrator
d-i passwd/username string sysadmin
d-i passwd/user-password password Admin2024!Secure
d-i passwd/user-password-again password Admin2024!Secure

### Clock and Timezone - India
d-i time/zone string Asia/Kolkata
d-i clock-setup/utc boolean true
d-i clock-setup/ntp boolean true
d-i clock-setup/ntp-server string in.pool.ntp.org

### Partitioning - Intelligent Disk Selection with Btrfs
# This section handles multiple disk scenarios intelligently

d-i partman/early_command string \
    debconf-set partman-auto/disk "$(list-devices disk | head -n1)"

d-i partman-auto/method string btrfs
d-i partman-auto/disk string /dev/sda
d-i partman-lvm/device_remove_lvm boolean true
d-i partman-md/device_remove_md boolean true
d-i partman-lvm/confirm boolean true
d-i partman-lvm/confirm_nooverwrite boolean true

# Custom Btrfs partitioning recipe
d-i partman-auto/expert_recipe string                         \
      btrfs-production ::                                     \
              512 512 512 fat32                               \
                      $primary{ }                             \
                      $iflabel{ gpt }                         \
                      $reusemethod{ }                         \
                      method{ efi }                           \
                      format{ }                               \
              .                                               \
              1024 1024 1024 ext4                             \
                      $primary{ }                             \
                      $bootable{ }                            \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ ext4 }    \
                      mountpoint{ /boot }                     \
              .                                               \
              4096 8192 8192 linux-swap                       \
                      $primary{ }                             \
                      method{ swap } format{ }                \
              .                                               \
              20000 30000 -1 btrfs                            \
                      $primary{ }                             \
                      method{ format } format{ }              \
                      use_filesystem{ } filesystem{ btrfs }   \
                      mountpoint{ / }                         \
                      options/noatime{ noatime }              \
                      options/compress{ compress=zstd:1 }     \
              .

d-i partman-basicfilesystems/no_mount_point boolean false
d-i partman-partitioning/confirm_write_new_label boolean true
d-i partman/choose_partition select finish
d-i partman/confirm boolean true
d-i partman/confirm_nooverwrite boolean true

### Base System Installation
d-i base-installer/kernel/override-image string linux-server

### APT Configuration
d-i apt-setup/non-free boolean true
d-i apt-setup/contrib boolean true
d-i apt-setup/services-select multiselect security, updates
d-i apt-setup/security_host string security.debian.org

### Package Selection - Minimal + Testing Tools
tasksel tasksel/first multiselect standard, ssh-server

d-i pkgsel/include string \
    vim nano htop curl wget git net-tools ca-certificates \
    btrfs-progs snapper grub-btrfs inotify-tools \
    python3 python3-dbus rsync sudo \
    build-essential linux-headers-amd64 \
    openssh-server ufw fail2ban \
    tmux screen ncdu tree \
    ethtool bridge-utils vlan

d-i pkgsel/upgrade select full-upgrade
popularity-contest popularity-contest/participate boolean false

### GRUB Bootloader
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
d-i grub-installer/bootdev string default

### Post-Installation - Btrfs Subvolume Setup and Configuration
d-i preseed/late_command string \
    in-target bash -c ' \
    set -e; \
    exec > >(tee -a /var/log/preseed-post-install.log) 2>&1; \
    \
    echo "=== [$(date)] Starting Btrfs Post-Installation Setup ===" ; \
    \
    # Get root partition device and UUID \
    ROOT_DEV=$(mount | grep "on /target " | awk '"'"'{print $1}'"'"'); \
    BTRFS_UUID=$(blkid -s UUID -o value $ROOT_DEV); \
    echo "Root device: $ROOT_DEV"; \
    echo "Btrfs UUID: $BTRFS_UUID"; \
    \
    # Create temporary mount point \
    mkdir -p /mnt/btrfs-root; \
    mount -t btrfs $ROOT_DEV /mnt/btrfs-root; \
    \
    # Create Btrfs subvolume structure \
    echo "Creating Btrfs subvolumes..."; \
    cd /mnt/btrfs-root; \
    \
    # Create @ subvolume and move root content \
    btrfs subvolume create @; \
    echo "Copying root filesystem to @ subvolume..."; \
    rsync -aAXHv --exclude={"/dev/*","/proc/*","/sys/*","/tmp/*","/run/*","/mnt/*","/media/*","/lost+found"} /target/ /mnt/btrfs-root/@/; \
    \
    # Create additional subvolumes \
    btrfs subvolume create @home; \
    btrfs subvolume create @var_log; \
    btrfs subvolume create @snapshots; \
    btrfs subvolume create @tmp; \
    \
    # Move existing data to subvolumes \
    if [ -d /target/home ] && [ "$(ls -A /target/home)" ]; then \
        rsync -aAXHv /target/home/ /mnt/btrfs-root/@home/; \
    fi; \
    \
    if [ -d /target/var/log ] && [ "$(ls -A /target/var/log)" ]; then \
        rsync -aAXHv /target/var/log/ /mnt/btrfs-root/@var_log/; \
    fi; \
    \
    # Unmount and remount with proper subvolumes \
    cd /; \
    umount /mnt/btrfs-root; \
    umount /target/boot/efi || true; \
    umount /target/boot; \
    umount /target; \
    \
    # Remount root with @ subvolume \
    mount -o subvol=@,compress=zstd:1,noatime $ROOT_DEV /target; \
    \
    # Create and mount other subvolumes \
    mkdir -p /target/{home,var/log,.snapshots,tmp}; \
    mount -o subvol=@home,compress=zstd:1,noatime $ROOT_DEV /target/home; \
    mount -o subvol=@var_log,compress=zstd:1,noatime $ROOT_DEV /target/var/log; \
    mount -o subvol=@snapshots,noatime $ROOT_DEV /target/.snapshots; \
    mount -o subvol=@tmp,compress=zstd:1,noatime $ROOT_DEV /target/tmp; \
    \
    # Remount boot partitions \
    BOOT_DEV=$(blkid | grep -E "LABEL=\"boot\"" | cut -d: -f1 || echo ""); \
    if [ -n "$BOOT_DEV" ]; then \
        mount $BOOT_DEV /target/boot; \
    fi; \
    \
    EFI_DEV=$(blkid | grep -E "TYPE=\"vfat\"" | head -n1 | cut -d: -f1 || echo ""); \
    if [ -n "$EFI_DEV" ]; then \
        mkdir -p /target/boot/efi; \
        mount $EFI_DEV /target/boot/efi; \
    fi; \
    \
    # Generate new fstab with Btrfs subvolumes \
    echo "Generating fstab..."; \
    cat > /target/etc/fstab << '"'"'EOF'"'"'
# Btrfs Production Environment - Auto-configured
# Root filesystem with @ subvolume
UUID=$BTRFS_UUID  /            btrfs  defaults,subvol=@,compress=zstd:1,noatime,space_cache=v2  0  1
UUID=$BTRFS_UUID  /home        btrfs  defaults,subvol=@home,compress=zstd:1,noatime  0  2
UUID=$BTRFS_UUID  /var/log     btrfs  defaults,subvol=@var_log,compress=zstd:1,noatime  0  2
UUID=$BTRFS_UUID  /.snapshots  btrfs  defaults,subvol=@snapshots,noatime  0  2
UUID=$BTRFS_UUID  /tmp         btrfs  defaults,subvol=@tmp,compress=zstd:1,noatime  0  2
EOF
    \
    # Add boot and swap partitions to fstab \
    if [ -n "$BOOT_DEV" ]; then \
        BOOT_UUID=$(blkid -s UUID -o value $BOOT_DEV); \
        echo "UUID=$BOOT_UUID  /boot  ext4  defaults  0  2" >> /target/etc/fstab; \
    fi; \
    \
    if [ -n "$EFI_DEV" ]; then \
        EFI_UUID=$(blkid -s UUID -o value $EFI_DEV); \
        echo "UUID=$EFI_UUID  /boot/efi  vfat  umask=0077  0  1" >> /target/etc/fstab; \
    fi; \
    \
    SWAP_DEV=$(blkid | grep -E "TYPE=\"swap\"" | cut -d: -f1 || echo ""); \
    if [ -n "$SWAP_DEV" ]; then \
        SWAP_UUID=$(blkid -s UUID -o value $SWAP_DEV); \
        echo "UUID=$SWAP_UUID  none  swap  sw  0  0" >> /target/etc/fstab; \
    fi; \
    \
    # Configure Snapper \
    echo "Configuring Snapper..."; \
    chroot /target snapper -c root create-config /; \
    \
    # Remove default .snapshots subvolume created by snapper \
    chroot /target btrfs subvolume delete /.snapshots 2>/dev/null || true; \
    mkdir -p /target/.snapshots; \
    mount -o subvol=@snapshots,noatime $ROOT_DEV /target/.snapshots; \
    \
    # Configure Snapper for production use \
    cat > /target/etc/snapper/configs/root << '"'"'SNAPEOF'"'"'
SUBVOLUME="/"
FSTYPE="btrfs"
QGROUP=""
SPACE_LIMIT="0.5"
FREE_LIMIT="0.2"
ALLOW_USERS=""
ALLOW_GROUPS=""
SYNC_ACL="no"
BACKGROUND_COMPARISON="yes"
NUMBER_CLEANUP="yes"
NUMBER_MIN_AGE="1800"
NUMBER_LIMIT="20"
NUMBER_LIMIT_IMPORTANT="10"
TIMELINE_MIN_AGE="1800"
TIMELINE_LIMIT_HOURLY="10"
TIMELINE_LIMIT_DAILY="7"
TIMELINE_LIMIT_WEEKLY="4"
TIMELINE_LIMIT_MONTHLY="6"
TIMELINE_LIMIT_YEARLY="2"
TIMELINE_CREATE="yes"
EMPTY_PRE_POST_CLEANUP="yes"
EMPTY_PRE_POST_MIN_AGE="1800"
SNAPEOF
    \
    # Set proper permissions \
    chroot /target chmod 750 /.snapshots; \
    \
    # Enable grub-btrfsd for automatic GRUB updates \
    chroot /target systemctl enable grub-btrfsd.service; \
    \
    # Configure GRUB for snapshot booting \
    echo "Configuring GRUB..."; \
    cat >> /target/etc/default/grub << '"'"'GRUBEOF'"'"'

# Btrfs Snapshot Configuration
GRUB_TIMEOUT=10
GRUB_BTRFS_SUBMENUNAME="System Snapshots"
GRUB_BTRFS_SNAPSHOT_BOOTING="true"
GRUB_BTRFS_SNAPSHOT_BOOTING_SORT="descending"
GRUB_BTRFS_LIMIT="10"
GRUBEOF
    \
    # Create snapshot management scripts \
    echo "Creating snapshot management scripts..."; \
    \
    cat > /target/usr/local/bin/snapshot-create << '"'"'SCRIPTEOF'"'"'
#!/bin/bash
# Create pre-change snapshot
DESC="${1:-Manual snapshot $(date +%Y%m%d_%H%M%S)}"
echo "Creating snapshot: $DESC"
sudo snapper -c root create --description "$DESC" --cleanup-algorithm number
SNAP_NUM=$(sudo snapper -c root list | tail -n 1 | awk '"'"'{print $1}'"'"')
echo "$SNAP_NUM" > /tmp/last_snapshot_num
echo "✓ Snapshot #$SNAP_NUM created successfully"
sudo snapper -c root list | tail -n 5
SCRIPTEOF
    \
    cat > /target/usr/local/bin/snapshot-rollback << '"'"'SCRIPTEOF'"'"'
#!/bin/bash
# Rollback to last snapshot
if [ -f /tmp/last_snapshot_num ]; then
    SNAP_NUM=$(cat /tmp/last_snapshot_num)
    echo "Rolling back to snapshot #$SNAP_NUM"
    sudo snapper -c root undochange $SNAP_NUM..0
else
    echo "No recent snapshot found. Using Snapper rollback..."
    sudo snapper rollback
fi
echo "✓ Rollback prepared. Rebooting in 5 seconds..."
sleep 5
sudo systemctl reboot
SCRIPTEOF
    \
    cat > /target/usr/local/bin/snapshot-list << '"'"'SCRIPTEOF'"'"'
#!/bin/bash
# List all snapshots
sudo snapper -c root list
SCRIPTEOF
    \
    cat > /target/usr/local/bin/snapshot-cleanup << '"'"'SCRIPTEOF'"'"'
#!/bin/bash
# Cleanup old snapshots
echo "Cleaning up old snapshots..."
sudo snapper -c root cleanup number
echo "✓ Cleanup complete"
sudo snapper -c root list
SCRIPTEOF
    \
    # Make scripts executable \
    chmod +x /target/usr/local/bin/snapshot-*; \
    \
    # Create system info script \
    cat > /target/usr/local/bin/system-info << '"'"'INFOEOF'"'"'
#!/bin/bash
echo "=== System Information ==="
echo "Hostname: $(hostname)"
echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d \")"
echo ""
echo "=== Credentials (Default) ==="
echo "Root Password: SecureRoot2024!"
echo "User: sysadmin"
echo "Password: Admin2024!Secure"
echo ""
echo "=== Network ==="
ip -br addr show
echo ""
echo "=== Btrfs Subvolumes ==="
sudo btrfs subvolume list /
echo ""
echo "=== Snapshots ==="
sudo snapper -c root list
echo ""
echo "=== Disk Usage ==="
df -h | grep -E "Filesystem|/dev/"
INFOEOF
    \
    chmod +x /target/usr/local/bin/system-info; \
    \
    # Configure sudo for sysadmin \
    echo "sysadmin ALL=(ALL:ALL) NOPASSWD:ALL" > /target/etc/sudoers.d/sysadmin; \
    chmod 440 /target/etc/sudoers.d/sysadmin; \
    \
    # Configure SSH \
    sed -i "s/#PermitRootLogin prohibit-password/PermitRootLogin yes/" /target/etc/ssh/sshd_config; \
    \
    # Configure firewall \
    chroot /target ufw allow 22/tcp; \
    chroot /target ufw --force enable; \
    \
    # Update initramfs and GRUB \
    echo "Updating initramfs and GRUB..."; \
    chroot /target update-initramfs -u -k all; \
    chroot /target update-grub; \
    \
    # Create golden baseline snapshot \
    echo "Creating golden baseline snapshot..."; \
    chroot /target snapper -c root create --description "Golden Baseline - Fresh Install $(date +%Y-%m-%d)" --cleanup-algorithm number; \
    \
    # Create MOTD with credentials \
    cat > /target/etc/motd << '"'"'MOTDEOF'"'"'
╔══════════════════════════════════════════════════════════════╗
║          Debian 12.12 Btrfs Production System                ║
║          Automated Installation Complete                     ║
╚══════════════════════════════════════════════════════════════╝

Default Credentials:
  Root:     SecureRoot2024!
  User:     sysadmin / Admin2024!Secure

Snapshot Management:
  snapshot-create [description]  - Create new snapshot
  snapshot-rollback              - Rollback to last snapshot
  snapshot-list                  - List all snapshots
  snapshot-cleanup               - Clean old snapshots
  system-info                    - Display system information

Run 'system-info' for complete system details.

MOTDEOF
    \
    # Log completion \
    echo "=== [$(date)] Btrfs Post-Installation Complete ===" ; \
    echo "Installation log: /var/log/preseed-post-install.log" ; \
    ' ;

### Finish Installation
d-i finish-install/reboot_in_progress note
d-i debian-installer/exit/poweroff boolean false